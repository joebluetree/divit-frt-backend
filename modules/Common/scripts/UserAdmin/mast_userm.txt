
CREATE TABLE IF NOT EXISTS mast_userm (
    user_id int4 GENERATED BY DEFAULT AS IDENTITY,
    user_code varchar(20) NOT NULL,
    user_name varchar(60) NOT NULL,
    user_password varchar(20) NULL,
    user_email varchar(60) NOT NULL,
    user_is_admin bpchar(1) NOT NULL,
    rec_version int4 DEFAULT 1 NOT NULL,
    rec_locked bpchar(1) DEFAULT 'N'::bpchar NOT NULL,
    rec_created_by varchar(20) NOT NULL,
    rec_created_date timestamptz NOT NULL,
    rec_edited_by varchar(20) NULL,
    rec_edited_date timestamptz NULL,
    rec_company_id int4 NOT NULL,
    rec_branch_id int4 NOT NULL,
    CONSTRAINT pk_mast_userm_user_id PRIMARY KEY (user_id),
    CONSTRAINT fk_mast_userm_rec_company_id FOREIGN KEY (rec_company_id) REFERENCES mast_companym(comp_id),
    CONSTRAINT fk_mast_userm_rec_branch_id FOREIGN KEY (rec_branch_id) REFERENCES mast_branchm(branch_id)
);


DO $$
BEGIN

    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'IX_mast_userm_rec_branch_id') THEN
        CREATE INDEX "IX_mast_userm_rec_branch_id" ON mast_userm USING btree (rec_branch_id);
    END IF;


    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'uq_mast_userm_user_code') THEN
        CREATE UNIQUE INDEX uq_mast_userm_user_code ON mast_userm USING btree (rec_company_id, user_code);
    END IF;


    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'uq_mast_userm_user_name') THEN
        CREATE UNIQUE INDEX uq_mast_userm_user_name ON mast_userm USING btree (rec_company_id, user_name);
    END IF;
END $$;


INSERT INTO mast_userm (user_id, user_code, user_name, user_password, user_email, user_is_admin, rec_version, rec_locked, rec_created_by, rec_created_date, rec_company_id, rec_branch_id)
SELECT 1, 'ADMIN', 'ADMIN', 'ADMIN', 'admin@gmail.com', 'Y', 1, 'N', 'ADMIN', NOW(), 1, 1
WHERE NOT EXISTS (SELECT 1 FROM mast_userm WHERE user_id = 1);

INSERT INTO mast_userm (user_id, user_code, user_name, user_password, user_email, user_is_admin, rec_version, rec_locked, rec_created_by, rec_created_date, rec_company_id, rec_branch_id)
SELECT 2, 'USER1', 'USER1', 'USER1', 'user1@gmail.com', 'N', 1, 'N', 'ADMIN', NOW(), 1, 1
WHERE NOT EXISTS (SELECT 1 FROM mast_userm WHERE user_id = 2);

INSERT INTO mast_userm (user_id, user_code, user_name, user_password, user_email, user_is_admin, rec_version, rec_locked, rec_created_by, rec_created_date, rec_company_id, rec_branch_id)
SELECT 3, 'USER2', 'USER2', 'USER2', 'user2@gmail.com', 'N', 1, 'N', 'ADMIN', NOW(), 1, 1
WHERE NOT EXISTS (SELECT 1 FROM mast_userm WHERE user_id = 3);

SELECT setval(pg_get_serial_sequence('mast_userm', 'user_id'), 
              COALESCE(MAX(user_id), 1), 
              true) 
FROM mast_userm;