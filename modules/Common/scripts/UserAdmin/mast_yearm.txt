CREATE TABLE IF NOT EXISTS mast_yearm
(
  year_id             int4 GENERATED BY DEFAULT AS IDENTITY,
  year_code             int4 not null,
  year_name             varchar(25) not null,
  year_start_date       date not null,
  year_end_date         date not null,
  year_closed           bpchar(1) DEFAULT 'N'::bpchar NOT NULL,
  year_default          bpchar(1) DEFAULT 'N'::bpchar NOT NULL,  
  rec_created_by varchar(20) NOT NULL,
  rec_created_date timestamptz NOT NULL,
  rec_edited_by varchar(20) NULL,
  rec_edited_date timestamptz NULL,  
  rec_company_id int4 NOT null,
  CONSTRAINT pk_mast_yearm_year_id PRIMARY KEY (year_id)
);

DO $$  
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE  indexname = 'uq_mast_yearm_year_code') THEN
        CREATE UNIQUE INDEX uq_mast_yearm_year_code ON mast_yearm USING btree (year_code, rec_company_id);
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'IX_mast_yearm_rec_company_id') THEN  
        CREATE INDEX "IX_mast_yearm_rec_company_id" ON mast_yearm USING btree (rec_company_id);  
    END IF;  
END $$;

INSERT INTO mast_yearm  
(year_id, year_code, year_name,year_start_date, year_end_date, year_closed, year_default,rec_created_by, rec_created_date,rec_company_id)  
SELECT 1,2023,'2023-2024', '2023-04-01','2024-03-31','N', 'N', 'ADMIN', now(), 1  
WHERE NOT EXISTS (SELECT 1 FROM mast_yearm WHERE year_id = 1);

INSERT INTO mast_yearm  
(year_id, year_code, year_name,year_start_date, year_end_date, year_closed, year_default,rec_created_by, rec_created_date,rec_company_id)  
SELECT 2,2024,'2024-2025', '2024-04-01','2025-03-31','N', 'N', 'ADMIN', now(), 1  
WHERE NOT EXISTS (SELECT 1 FROM mast_yearm WHERE year_id = 2);  

INSERT INTO mast_yearm  
(year_id, year_code, year_name,year_start_date, year_end_date, year_closed, year_default,rec_created_by, rec_created_date,rec_company_id)  
SELECT 3,2025,'2025-2026', '2025-04-01','2026-03-31','N', 'Y', 'ADMIN', now(), 1  
WHERE NOT EXISTS (SELECT 1 FROM mast_yearm WHERE year_id = 3);


SELECT setval(pg_get_serial_sequence('mast_yearm', 'year_id'), 
              COALESCE(MAX(year_id), 1), 
              true) 
FROM mast_yearm;
